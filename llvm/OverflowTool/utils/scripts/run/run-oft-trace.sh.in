#!/usr/bin/env bash

# vim: filetype=bash

# discover current dir and expect library dir to be one level up
LIB_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)/../@CMAKE_INSTALL_LIBDIR@"

FILENAME=${1}
OUTPUT_FILENAME=${FILENAME%.*}-trace.ll

PASS_LIB_FILENAME=$<IF:$<STREQUAL:"@PRJ_SHARED_MODE@","MODULE">,$<TARGET_FILE_NAME:@LIB_NAME@>,>

MODE="$(llvm-config --assertion-mode)"

if [[ "${MODE,,}" == "on" ]]; then
  OPTIONS+=(
    "-debug-pass-manager"
  )
fi

if [[ ! -z ${PASS_LIB_FILENAME} ]]; then
  OPTIONS+=("-load-pass-plugin ${LIB_DIR}/${PASS_LIB_FILENAME}")
fi

opt \
  ${OPTIONS[@]} \
  -S \
  -passes='require<oft-scale-var-tracing>' \
  -o "${OUTPUT_FILENAME}" \
  "${FILENAME}"
