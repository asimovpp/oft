#!/usr/bin/env bash

# discover current dir and expect library dir to be one level up
LIB_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)/../@CMAKE_INSTALL_LIBDIR@"

FILENAME=${1}
OUTPUT_FILENAME=${FILENAME%.*}-manual-annot-sel.ll

PASS_LIB_FILENAME=$<IF:$<STREQUAL:"@PRJ_SHARED_MODE@","MODULE">,$<TARGET_FILE_NAME:@LIB_NAME@>,>

OPTIONS=()

OPTIONS+=(
  "-debug-pass-manager"
  "-debug-only=oft-manual-annotation-selection"
  "-debug-only=oft-manual-annotation-selection-analysis"
)

if [[ ! -z ${PASS_LIB_FILENAME} ]]; then
  OPTIONS+=("-load-pass-plugin ${LIB_DIR}/${PASS_LIB_FILENAME}")
fi

opt \
  ${OPTIONS[@]} \
  -S \
  -passes='require<oft-manual-annotation-selection>' \
  -o "${OUTPUT_FILENAME}" \
  "${FILENAME}"
